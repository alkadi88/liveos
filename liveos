import React, { useState, useEffect, useMemo } from 'react';
import { Plus, MoreHorizontal, BookOpen, Target, Lightbulb, Clock, Move, Trash2, Sparkles, Wand2, Loader2, CheckCircle2, X, Check, Link as LinkIcon, Image as ImageIcon, Tag, Filter, Edit3, FileText, ExternalLink } from 'lucide-react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

// --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ²Ø§Ù…Ù†
const firebaseConfig = {
  apiKey: import.meta.env?.VITE_FIREBASE_API_KEY || "",
  authDomain: import.meta.env?.VITE_FIREBASE_AUTH_DOMAIN || "",
  projectId: import.meta.env?.VITE_FIREBASE_PROJECT_ID || "",
  storageBucket: import.meta.env?.VITE_FIREBASE_STORAGE_BUCKET || "",
  messagingSenderId: import.meta.env?.VITE_FIREBASE_MESSAGING_SENDER_ID || "",
  appId: import.meta.env?.VITE_FIREBASE_APP_ID || ""
};

// Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Firebase Ø¨Ø£Ù…Ø§Ù†
let app, auth, db;
try {
  if (!getApps().length && firebaseConfig.apiKey) {
    app = initializeApp(firebaseConfig);
  } else if (getApps().length) {
    app = getApp();
  }
  
  if (app) {
    auth = getAuth(app);
    db = getFirestore(app);
  }
} catch (error) {
  console.warn("Firebase initialization skipped due to missing config.", error);
}

// Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ÙŠØ­ØªØ§Ø¬ Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø­Ù‚Ø§Ù‹)
const apiKey = ""; 

// --- 2. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ---
const defaultBoardData = {
  columns: {
    'col-1': {
      id: 'col-1',
      title: 'Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø­Ø§Ù„ÙŠ',
      iconType: 'Target',
      color: 'bg-red-100',
      items: [
        { id: 'item-1', content: 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©', tag: 'Ø¹Ø§Ø¬Ù„', tagColor: 'bg-red-100 text-red-600', date: 'Ù…Ù†Ø° Ø³Ø§Ø¹ØªÙŠÙ†', description: 'ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø¹ÙØ´', attachmentLink: '', image: '' },
      ],
    },
    'col-2': {
      id: 'col-2',
      title: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ©',
      iconType: 'BookOpen',
      color: 'bg-yellow-100',
      items: [
        { id: 'item-3', content: 'ÙƒØªØ§Ø¨: Ø§Ù„Ø¯Ù…Ø§Øº Ø§Ù„Ù…Ø¹ØªÙ‚Ø¯', tag: 'Ù‚Ø±Ø§Ø¡Ø©', tagColor: 'bg-green-100 text-green-600', date: 'Ù…Ù†Ø° 4 Ø³Ø§Ø¹Ø§Øª', description: '', attachmentLink: '', image: '' },
      ],
    },
    'col-3': {
      id: 'col-3',
      title: 'Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ£ÙÙƒØ§Ø±',
      iconType: 'Lightbulb',
      color: 'bg-purple-100',
      items: [
        { id: 'item-6', content: 'Ù…Ø´Ø±ÙˆØ¹ LifeOS', tag: 'Ø¨Ø²Ù†Ø³', tagColor: 'bg-purple-100 text-purple-600', date: 'Ø§Ù„ÙŠÙˆÙ…', description: '', attachmentLink: '', image: 'https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?auto=format&fit=crop&w=400&q=80' },
      ],
    },
  },
  columnOrder: ['col-1', 'col-2', 'col-3'],
};

export default function LifeOSBoard() {
  // --- States ---
  const [data, setData] = useState(defaultBoardData); // Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¯ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø§ØªØµØ§Ù„
  const [user, setUser] = useState(null);
  const [draggedItem, setDraggedItem] = useState(null);
  const [draggedSourceCol, setDraggedSourceCol] = useState(null);
  
  // Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø±ÙŠØ±
  const [addingToColumn, setAddingToColumn] = useState(null);
  const [newCardTitle, setNewCardTitle] = useState("");
  const [editingItem, setEditingItem] = useState(null);
  const [activeColId, setActiveColId] = useState(null);

  // ÙÙ„ØªØ±Ø©
  const [activeFilter, setActiveFilter] = useState('All');

  // AI
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [activeAiColId, setActiveAiColId] = useState(null);

  // --- Firebase Auth & Sync ---
  useEffect(() => {
    if (!auth) return; // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ FirebaseØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹
    
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.error("Auth Error:", e);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    const docRef = doc(db, 'users', user.uid, 'boards', 'main');
    const unsubscribe = onSnapshot(docRef, (snapshot) => {
      if (snapshot.exists()) setData(snapshot.data());
      else { setDoc(docRef, defaultBoardData); }
    });
    return () => unsubscribe();
  }, [user]);

  const saveDataToFirebase = async (newData) => {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ÙŠØ´Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø³Ø±Ø¹Ø©
    setData(newData);
    
    if (!user || !db) return;
    try { await setDoc(doc(db, 'users', user.uid, 'boards', 'main'), newData); } 
    catch (error) { console.error("Error saving:", error); }
  };

  // --- Helpers ---
  const allTags = useMemo(() => {
    if (!data) return [];
    const tags = new Set(['All']);
    Object.values(data.columns).forEach(col => {
        col.items.forEach(item => {
            if(item.tag) tags.add(item.tag);
        });
    });
    return Array.from(tags);
  }, [data]);

  const filteredData = useMemo(() => {
      if (!data) return null;
      if (activeFilter === 'All') return data;

      const newColumns = {};
      Object.keys(data.columns).forEach(key => {
          const col = data.columns[key];
          newColumns[key] = {
              ...col,
              items: col.items.filter(item => item.tag === activeFilter)
          };
      });

      return { ...data, columns: newColumns };
  }, [data, activeFilter]);


  // --- Actions ---

  const handleDeleteCard = (columnId, cardId, e) => {
    e.preventDefault();
    e.stopPropagation();

    if (window.confirm('ğŸ—‘ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
        const newData = {
            ...data,
            columns: {
                ...data.columns,
                [columnId]: {
                    ...data.columns[columnId],
                    items: data.columns[columnId].items.filter(i => i.id !== cardId)
                }
            }
        };
        saveDataToFirebase(newData);
    }
  };

  const openEditModal = (item, columnId, e) => {
      e.preventDefault();
      e.stopPropagation();
      setEditingItem({ ...item });
      setActiveColId(columnId);
  };

  const saveEditedItem = () => {
      if (!editingItem || !activeColId) return;
      
      const newData = { ...data };
      const colItems = newData.columns[activeColId].items;
      const idx = colItems.findIndex(i => i.id === editingItem.id);
      
      if (idx > -1) {
          colItems[idx] = editingItem;
          saveDataToFirebase(newData);
      }
      setEditingItem(null);
      setActiveColId(null);
  };

  const handleAiBrainstorm = async (columnId, columnTitle) => {
    if (isAiLoading) return;
    if (!apiKey) { alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Gemini API Ø£ÙˆÙ„Ø§Ù‹"); return; }
    
    setIsAiLoading(true);
    setActiveAiColId(columnId);
    const prompt = `Ø§Ù‚ØªØ±Ø­ 3 Ù…Ù‡Ø§Ù… Ù‚ØµÙŠØ±Ø© Ù„Ù‚Ø§Ø¦Ù…Ø©: "${columnTitle}".`;
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "STRING" } } } })
        });
        const result = await response.json();
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§Ù Ù‡ÙŠÙƒÙ„ÙŠØ© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
        let suggestions = [];
        try {
           suggestions = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text);
        } catch(e) {
           console.error("Error parsing AI response", e);
        }

        if (suggestions && Array.isArray(suggestions)) {
            const newItems = suggestions.map((text, i) => ({
                id: `ai-${Date.now()}-${i}`, content: text, date: 'Ù…Ù‚ØªØ±Ø­ Ø°ÙƒÙŠ', tag: 'AI', tagColor: 'bg-indigo-50 text-indigo-600', description: '', attachmentLink: '', image: ''
            }));
            const newData = { ...data, columns: { ...data.columns, [columnId]: { ...data.columns[columnId], items: [...data.columns[columnId].items, ...newItems] } } };
            saveDataToFirebase(newData);
        }
    } catch (e) { console.error(e); }
    setIsAiLoading(false); setActiveAiColId(null);
  };

  // DnD
  const handleDrop = (e, destColId) => {
    e.preventDefault();
    if (!draggedItem || !draggedSourceCol || draggedSourceCol === destColId) return;
    const newData = { ...data };
    newData.columns[draggedSourceCol].items = newData.columns[draggedSourceCol].items.filter(i => i.id !== draggedItem.id);
    newData.columns[destColId].items = [draggedItem, ...newData.columns[destColId].items];
    saveDataToFirebase(newData);
    setDraggedItem(null); setDraggedSourceCol(null);
  };

  // Add Card
  const confirmAddCard = (columnId) => {
    if (!newCardTitle.trim()) return;
    const newCard = { id: Date.now().toString(), content: newCardTitle, date: 'Ø§Ù„Ø¢Ù†', tag: 'Ø¬Ø¯ÙŠØ¯', tagColor: 'bg-gray-100 text-gray-600', description: '', attachmentLink: '', image: '' };
    const newData = { ...data, columns: { ...data.columns, [columnId]: { ...data.columns[columnId], items: [...data.columns[columnId].items, newCard] } } };
    saveDataToFirebase(newData); setAddingToColumn(null); setNewCardTitle("");
  };

  const handleAddColumn = () => {
      const id = `col-${Date.now()}`;
      const newData = { ...data, columns: { ...data.columns, [id]: { id, title: "Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯", iconType: 'Default', color: 'bg-gray-100', items: [] } }, columnOrder: [...data.columnOrder, id] };
      saveDataToFirebase(newData);
  };

  if (!data) return <div className="flex h-screen items-center justify-center gap-2 text-gray-500"><Loader2 className="animate-spin"/> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>;

  return (
    <div className="min-h-screen bg-[#f8fafc] text-gray-800 font-sans flex flex-col overflow-hidden" dir="rtl" style={{ fontFamily: '"Tajawal", sans-serif' }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        .pattern-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .hide-scrollbar::-webkit-scrollbar { height: 6px; }
        .hide-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-btn:hover { transform: scale(1.1); }
      `}</style>

      <div className="fixed inset-0 pattern-bg pointer-events-none z-0 opacity-40"></div>

      {/* Header */}
      <header className="px-6 py-4 bg-white/80 backdrop-blur-md border-b border-gray-200 z-20 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-sm">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
            <span className="text-lg">ğŸ¯</span>
          </div>
          <div>
            <h1 className="text-xl font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„Ø­ÙŠØ§Ø©</h1>
            <p className="text-[11px] text-gray-500 font-medium flex items-center gap-1">
               <span className={`w-2 h-2 rounded-full ${user ? 'bg-green-500' : 'bg-gray-300'} block`}></span> 
               {user ? 'Ù…ØªØµÙ„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' : 'ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ (Offline)'}
            </p>
          </div>
        </div>

        {/* Filter Bar */}
        <div className="flex items-center gap-2 overflow-x-auto hide-scrollbar py-1 max-w-full md:max-w-md">
            <Filter size={14} className="text-gray-400 shrink-0 ml-2" />
            {allTags.map(tag => (
                <button
                    key={tag}
                    onClick={() => setActiveFilter(tag)}
                    className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap ${activeFilter === tag ? 'bg-gray-800 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}`}
                >
                    {tag === 'All' ? 'Ø§Ù„ÙƒÙ„' : tag}
                </button>
            ))}
        </div>

        <div className="flex gap-2">
            <button onClick={handleAddColumn} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition-all text-sm font-bold shadow-lg shadow-indigo-200 active:scale-95">
                <Plus size={16} /> <span className="hidden md:inline">Ù„ÙˆØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
            </button>
        </div>
      </header>

      {/* Board Area */}
      <main className="flex-1 overflow-x-auto overflow-y-hidden p-4 md:p-6 hide-scrollbar relative z-10">
        <div className="flex h-full gap-5 w-max min-w-full">
          {filteredData.columnOrder.map((colId) => {
            const column = filteredData.columns[colId];
            if (!column) return null; 

            return (
              <div key={column.id} className="w-80 md:w-[340px] flex flex-col h-full max-h-full rounded-3xl bg-gray-50/50 border border-white/50 shadow-sm backdrop-blur-sm"
                  onDragOver={(e) => e.preventDefault()} 
                  onDrop={(e) => handleDrop(e, column.id)}>
                
                {/* Column Header */}
                <div className="flex justify-between items-center p-4">
                  <h2 className="font-bold text-gray-700 flex items-center gap-2">
                    <div className={`w-2 h-8 rounded-full ${column.color.replace('bg-', 'bg-').replace('100', '500')}`}></div>
                    {column.title}
                    <span className="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full">{column.items.length}</span>
                  </h2>
                  <button 
                    onClick={() => handleAiBrainstorm(column.id, column.title)} 
                    disabled={isAiLoading}
                    className="text-gray-400 hover:text-indigo-600 p-1.5 hover:bg-indigo-50 rounded-lg transition-all"
                    title="Ø§Ù‚ØªØ±Ø­ Ù…Ù‡Ø§Ù… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"
                  >
                    {activeAiColId === column.id ? <Loader2 size={16} className="animate-spin"/> : <Sparkles size={16}/>}
                  </button>
                </div>

                {/* Cards Container */}
                <div className="flex-1 overflow-y-auto px-3 pb-20 space-y-3 hide-scrollbar">
                  {column.items.map((item) => (
                    <div 
                      key={item.id} 
                      draggable="true" 
                      onDragStart={(e) => { setDraggedItem(item); setDraggedSourceCol(column.id); e.target.style.opacity = '0.5'; }}
                      onDragEnd={(e) => { setDraggedItem(null); setDraggedSourceCol(null); e.target.style.opacity = '1'; }}
                      className="group relative bg-white p-4 rounded-[20px] border border-gray-100 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-200 cursor-grab active:cursor-grabbing"
                    >
                        <div className="absolute top-3 left-3 flex gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity z-20">
                            <button 
                                onMouseDown={(e) => e.stopPropagation()}
                                onClick={(e) => openEditModal(item, column.id, e)}
                                className="card-btn bg-white text-blue-500 hover:text-blue-600 border border-gray-200 p-1.5 rounded-full shadow-sm" title="ØªØ¹Ø¯ÙŠÙ„ ÙˆØªÙØ§ØµÙŠÙ„"
                            >
                                <Edit3 size={13} />
                            </button>
                            <button 
                                onMouseDown={(e) => e.stopPropagation()}
                                onClick={(e) => handleDeleteCard(column.id, item.id, e)}
                                className="card-btn bg-white text-red-500 hover:text-red-600 border border-gray-200 p-1.5 rounded-full shadow-sm" title="Ø­Ø°Ù"
                            >
                                <Trash2 size={13} />
                            </button>
                        </div>

                        {item.image && (
                            <div className="h-32 mb-3 rounded-xl bg-gray-100 overflow-hidden">
                                <img src={item.image} alt="cover" className="w-full h-full object-cover" />
                            </div>
                        )}

                        {item.tag && <span className={`inline-block px-2 py-0.5 rounded-md text-[10px] font-bold mb-2 ${item.tagColor || 'bg-gray-100 text-gray-500'}`}>{item.tag}</span>}

                        <h3 className="font-bold text-gray-800 text-sm leading-relaxed mb-1">{item.content}</h3>
                        
                        <div className="flex flex-wrap gap-2 mt-2">
                            {item.description && <FileText size={12} className="text-gray-400" />}
                            {item.attachmentLink && <LinkIcon size={12} className="text-blue-400" />}
                        </div>

                        <div className="flex justify-between items-center mt-3 pt-2 border-t border-gray-50 text-[10px] text-gray-400">
                            <div className="flex items-center gap-1"><Clock size={10}/> {item.date}</div>
                        </div>
                    </div>
                  ))}

                  {addingToColumn === column.id ? (
                      <div className="bg-white p-3 rounded-[20px] border-2 border-indigo-100 shadow-md animate-in fade-in zoom-in duration-200">
                          <textarea autoFocus className="w-full text-sm font-medium border-none focus:ring-0 resize-none p-0" rows="2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©..." value={newCardTitle} onChange={e => setNewCardTitle(e.target.value)} onKeyDown={e => {if(e.key === 'Enter' && !e.shiftKey) {e.preventDefault(); confirmAddCard(column.id);}}}/>
                          <div className="flex justify-end gap-2 mt-2">
                              <button onClick={() => setAddingToColumn(null)} className="p-1 text-gray-400 hover:bg-red-50 rounded"><X size={16}/></button>
                              <button onClick={() => confirmAddCard(column.id)} className="px-3 py-1 bg-indigo-600 text-white rounded-lg text-xs font-bold"><Check size={14}/></button>
                          </div>
                      </div>
                  ) : (
                      <button onClick={() => {setAddingToColumn(column.id); setNewCardTitle('')}} className="w-full py-2.5 rounded-[18px] border border-dashed border-gray-300 text-gray-400 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 text-sm font-medium">
                          <Plus size={14}/> Ø¥Ø¶Ø§ÙØ©
                      </button>
                  )}
                </div>
              </div>
            );
          })}
           <div className="w-12 flex flex-col items-center pt-10 opacity-50 hover:opacity-100 cursor-pointer transition-opacity" onClick={handleAddColumn}>
               <div className="w-full h-full border-2 border-dashed border-gray-300 rounded-full flex items-center justify-center hover:bg-gray-100"><Plus className="text-gray-400"/></div>
           </div>
        </div>
      </main>

      {/* --- Edit Modal --- */}
      {editingItem && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4">
              <div className="bg-white w-full max-w-md rounded-[30px] shadow-2xl overflow-hidden animate-in zoom-in duration-200">
                  <div className="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                      <h3 className="font-bold text-lg flex items-center gap-2"><Edit3 size={18} className="text-indigo-600"/> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
                      <button onClick={() => setEditingItem(null)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={20}/></button>
                  </div>
                  
                  <div className="p-6 space-y-4">
                      <div>
                          <label className="text-xs font-bold text-gray-500 block mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                          <input type="text" className="w-full bg-gray-50 border-none rounded-xl px-4 py-2 font-bold text-gray-800 focus:ring-2 focus:ring-indigo-100" 
                            value={editingItem.content} onChange={(e) => setEditingItem({...editingItem, content: e.target.value})} />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">Ø§Ù„ÙˆØ³Ù… (Tag)</label>
                            <div className="relative">
                                <Tag size={14} className="absolute top-3 right-3 text-gray-400"/>
                                <input type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø²Ù†Ø³" className="w-full bg-gray-50 border-none rounded-xl pr-9 pl-4 py-2 text-sm focus:ring-2 focus:ring-indigo-100" 
                                    value={editingItem.tag || ''} onChange={(e) => setEditingItem({...editingItem, tag: e.target.value})} />
                            </div>
                        </div>
                        <div>
                             <label className="text-xs font-bold text-gray-500 block mb-1">Ù„ÙˆÙ† Ø§Ù„ÙˆØ³Ù…</label>
                             <select className="w-full bg-gray-50 border-none rounded-xl px-3 py-2 text-sm text-gray-600"
                                value={editingItem.tagColor || ''} onChange={(e) => setEditingItem({...editingItem, tagColor: e.target.value})}>
                                 <option value="bg-gray-100 text-gray-600">Ø±Ù…Ø§Ø¯ÙŠ</option>
                                 <option value="bg-red-100 text-red-600">Ø£Ø­Ù…Ø±</option>
                                 <option value="bg-blue-100 text-blue-600">Ø£Ø²Ø±Ù‚</option>
                                 <option value="bg-green-100 text-green-600">Ø£Ø®Ø¶Ø±</option>
                                 <option value="bg-purple-100 text-purple-600">Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
                                 <option value="bg-orange-100 text-orange-600">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                             </select>
                        </div>
                      </div>

                      <div>
                          <label className="text-xs font-bold text-gray-500 block mb-1">Ø§Ù„ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                          <textarea rows="3" className="w-full bg-gray-50 border-none rounded-xl px-4 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-indigo-100 resize-none"
                            placeholder="Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±..."
                            value={editingItem.description || ''} onChange={(e) => setEditingItem({...editingItem, description: e.target.value})}></textarea>
                      </div>

                      <div>
                          <label className="text-xs font-bold text-gray-500 block mb-1">ØµÙˆØ±Ø© (Ø±Ø§Ø¨Ø· URL)</label>
                          <div className="relative">
                            <ImageIcon size={14} className="absolute top-3 right-3 text-gray-400"/>
                            <input type="text" placeholder="https://..." className="w-full bg-gray-50 border-none rounded-xl pr-9 pl-4 py-2 text-sm text-gray-600 focus:ring-2 focus:ring-indigo-100"
                                value={editingItem.image || ''} onChange={(e) => setEditingItem({...editingItem, image: e.target.value})} />
                          </div>
                      </div>

                      <div>
                          <label className="text-xs font-bold text-gray-500 block mb-1">Ø±Ø§Ø¨Ø· Ù…Ø±ÙÙ‚ (Drive/Link)</label>
                          <div className="relative">
                            <ExternalLink size={14} className="absolute top-3 right-3 text-gray-400"/>
                            <input type="text" placeholder="https://..." className="w-full bg-gray-50 border-none rounded-xl pr-9 pl-4 py-2 text-sm text-blue-500 underline focus:ring-2 focus:ring-indigo-100"
                                value={editingItem.attachmentLink || ''} onChange={(e) => setEditingItem({...editingItem, attachmentLink: e.target.value})} />
                          </div>
                      </div>
                  </div>

                  <div className="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                      <button onClick={() => setEditingItem(null)} className="px-5 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 rounded-xl transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
                      <button onClick={saveEditedItem} className="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
}
